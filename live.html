<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
        <link rel="stylesheet" type="text/css" href="css/icons-extra.css" />
		<style>
			ul {
				font-size: 14px;
				color: #000;
			}
			.mui-btn {
				padding: 10px;
			}
			#messages-box{
	            height:150px;
	            overflow:scroll;
	            font-size: 0.6em;
	        }
	        #messages-box{
				
	        }
	        
	        #messages-box dd{
	        		margin:0px;
	            padding:5px;
	            margin-left:5px;
	        }
	        #messages-box .receive{
				
	        }
	        #messages-box .to{
				color:#FF0000;	            
	        }
	        #chat-form{
	        		width:100%;
	        		position: fixed;
	        		bottom: 48px;
	        		padding-right: 59px;
	        }
	        #send-button{
	        		width:60px;
	        		position:absolute;
	        		height:40px;
	        		border-top-left-radius: 0px;
	        		border-bottom-left-radius:0px;
	        		top:0px;
	        		right:0px;
	        }
	        .apply-live-button{
	        		float:right;
	        }
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="padding-right: 15px;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color:#ffffff;"></a>
			<h1 class="mui-title">直播</h1>
			<button id='setting' class=" mui-pull-right mui-btn-link"></button>
		</header>
        <div class="mui-content">
        		<div class="top-bar">
        			房间：<span id="host"></span>
        			<span class="links">
        				<a class="apply-live-button" onclick="toApplyLive()">我要直播</a>
        			</span>
        		</div>
      		<div id="id_video_container_10905947996255835126" style="width:100%;height:1px;"></div>
      		<div id="chat-room">
      			<div id="messages-box">
      				
      			</div>
      			<div id="chat-form">
				    <input type="text" id="message-input">
				    <button id="send-button">发送</button>
      			</div>
      		</div>
        </div>
<!----底部---->
		<div style="height:60px"></div>
		<header class="mui-bar mui-bar-nav1" style="padding-right: 15px;height:60px">
			<div style="width:20%;height:50px;float:left;text-align:center;font-size:11px;"><a onclick="homeA()" style="color:#FFFFFF;"><span style="height:20px;" class="mui-icon mui-icon-home"></span><p style="height:20px;">首页</p></a></div>
			<div style="width:20%;height:50px;float:left;text-align:center;font-size:11px"><a onclick="zlcxA()" style="color:#FFFFFF;"><span style="height:20px;" class="mui-icon mui-icon-search"></span><p style="height:20px;">资料查询</p></a></div>
			<div style="width:20%;height:50px;float:left;text-align:center;font-size:11px;"><a onclick="passcxA()" style="color:#FFFFFF;"><span style="height:20px;padding-top:11px;"  class="mui-icon-extra mui-icon-extra-cart"></span><p style="height:20px;">PIN码查询</p></a></div>
			<div style="width:20%;height:50px;float:left;text-align:center;font-size:11px;"><a style="color:#FFFFFF;"><span style="height:20px;" class="mui-icon mui-icon-videocam"></span><p style="height:20px;">视频直播</p></a></div>
			<div style="width:20%;height:50px;float:left;text-align:center;font-size:11px;"><a onclick="settingA()" style="color:#FFFFFF;"><span style="height:20px;" class="mui-icon mui-icon-bars"></span><p style="height:20px;">更多</p></a></div>
		</header>
	</body>
	<script src="js/mui.min.js"></script>
	<script src="js/zepto.min.js"></script>
	<script src="js/app.js"></script>
	
	
	<script>
		
		mui.init();
	
		
	</script>
		<script src="http://imgcache.qq.com/open/qcloud/video/live/h5/live_connect.js" charset="utf-8"></script>
		 <script type="text/javascript">
		            (function(){
		            	   var liveWebView = plus.webview.getWebviewById('live');
		            	   var title = liveWebView.title;
		            	   $("#host").text(title);
		               var option ={"channel_id":liveWebView.channel_id,"app_id":liveWebView.app_id,"width":"1024","height":"768"};
		               new qcVideo.Player(
		                       /*代码中的id_video_container将会作为播放器放置的容器使用,可自行替换*/
		                       "id_video_container_10905947996255835126",
		                       option
		                   );
		             })()
	$(function () {
			var url = app.config.baseUrl + "live/buyWithPoint.php";
			var userszl = JSON.parse(localStorage.getItem("userzl"));
			var userValue=userszl.name;
			var liveWebView = plus.webview.getWebviewById('live');
	        mui.ajax(url,{ 
	            data: {
	            		username:userValue,
	            		live_id:liveWebView.live_id
	            },
	            dataType:'json',
	            type:'post',
	            success:function(data){
	            		console.log(JSON.stringify(data));
	            		
					if(data.status){
						return;
					}else{
						var message = data.message?data.message:"服务器错误!";
						plus.nativeUI.toast(message);
						setTimeout("mui.back()",500);
						return;
					}
	            }
	        });
			
			
		// chat box
        var timeFlag = 0;
        function longPolling() {

            $.ajax({
                url: "http://localhost/tinda_admin/chat.php",
                data:{
                    username:"testuser",
                    time:timeFlag,
                    channelID:"10905947996256161278"
                },
                dataType: "text",
                timeout: 10000,
                error: function (XMLHttpRequest, textStatus) {
                    setTimeout(longPolling,1000);
                },
                success: function (data, textStatus) {
                    data = JSON.parse(data);
                    var lastItem = data[data.length-1];
                    if(lastItem){
                        timeFlag = lastItem.created;
                    }

                    data.forEach(function(item){
                        $("#messages-box").append("<dd class='receive'>"+item.username + ": "+item.content+"</dd>")
                    	
                    })
                    scrollEnd();
                    setTimeout(longPolling,1000);
                }
            });

        }
        
        function scrollEnd(){
        		$('#messages-box').scrollTop( $('#messages-box')[0].scrollHeight );
        }

        // start polling
        longPolling();

        $("#send-button").click(function () {
            var content = $("#message-input").val();
            if(!content.trim()){
            		return ;
            }
            $("#messages-box").append("<dd class='to'>我:"+content+"</dd>")
            $("#message-input").val("");     
            scrollEnd();
            $.post(
                "http://localhost/tinda_admin/chat.php",
                {
                    username:"testuser",
                    content:content,
                    channelID:"10905947996256161278"
                },
                function(data){
                		if(data != 0){
                			alert("发送失败!");
                		}
                }
            )
        });
    });  
   
             
	 function toApplyLive(){
		mui.openWindow({
		    url:'applyLive.html',
		    id:'applyLive'
		});
	 }
 </script>          
</html>